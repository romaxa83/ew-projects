команды для скачивание схем бд (без данных) для тестирования
mysqldump -h 95.217.164.211 -u chnvoip_kamalio -pthaesoi3OojeuV2ahphip1eh kamailio --column-statistics=0 --no-data  > /home/romaxa/projects/voip-back/docker/data/dump/kamailio/kamailio.sql
mysqldump -h 95.217.164.211 -u chnvoip_asterisk -paul5Rup9rieja2ohb6Eizee9 asterisk --column-statistics=0 --no-data  > /home/romaxa/projects/voip-back/docker/data/dump/asterisk/asterisk.sql
--------------------------------------------------------------
Проверить что ip прода не в блеклисте ami


--------------------------------------------------------------
-- DEPARTMENT

- в терминологии asterisk - это queue

M DepartmentCreate - создание отдела
    - генерируется уникальный номер (num) для asterisk, это номер на который можно позвонить на очередь
    - создается запись в таблице "queues" (asterisk)
M DepartmentUpdate - редактирование отдела
    - редактируется запись в таблице "queues" (asterisk)
    - если изменилось имя, редактируется поле queue_name в таблице "queues_name" (asterisk)
M DepartmentDelete - удаление отдела
    - удаляется запись в таблице "queues" (asterisk)
    - нельзя удалить отдел, если у него есть привязанные сотрудники

Q Departments - список отделов с пагинацией
    - фильтры: id, per_page, page
    - доступен для employee
Q DepartmentsList - список отделов без пагинации
    - фильтры: id
    - доступен для employee
--------------------------------------------------------------
-- SIP

M SipCreate - создание sip
M SipUpdate - редактирование sip
	- если sip привязан к сотруднику - можно редактировать только пароль, если нет, то можно и номер
	- если sip привязан к сотруднику и у него есть запись в таблице "subscriber"(kamailio), она обновится
M SipDelete - удаление sip
	- если к sip привязан сотрудник, будет ошибка что нельзя удалить sip

Q Sips - список sip с пагинацией
    - фильтры: has_employee,id, per_page, page
    - доступен для employee
Q SipsList - список sip без пагинации
    - фильтры: has_employee, id
	    has_employee - получение списка у которых есть/нет привязанные сотрудники (для селекта при создании сотрудника)
    - доступен для employee
--------------------------------------------------------------
-- EMPLOYEE

- в терминологии kamailio - это subscriber
- в терминологии asterisk - это agent, если у него привязан sip
- sip у сотрудника не обязателен, но при создании сотрудника, его обязательно передовать,
    при редактирование это поле не обязательное его можно отвязывать

M EmployeeCreate - создание сотрудника
	- при создание отправляется письмо с кредами, если переданно поле send_email и оно true,
	если оно не передано или оно - false, письмо не уйдет
	- создается со статусом "free", но если привязанного sip нет в таблице location(kamailio),
	    то статус будет "error"
	- присваивается роль Employee Role, и ее разрешения
	- email уникален в разрезе админов и сотрудников
	- email сразу указывается как подтвержденый (без реального подтверждения)
	- если у пользователя есть sip, то создается запись в таблице "subscriber"(kamailio), поле - is_insert_kamailio проставляется true
	- создается запись в таблице "queue_members"(asterisk), поле - is_insert_queue проставляется true

M EmployeeUpdate - редактирование сотрудника
    - если обновляются поля - first_name, last_name, sip_id то обновляются данные в таблице "subscriber"(kamailio)
    - если отвязывается sip - удаляется его запись в таблице "subscriber"(kamailio), поле - is_insert_kamailio проставляется false,
        а также удаляется запись в таблице "queue_members"(asterisk), поле - is_insert_queue проставляется false
    - если у сотрудника не было sip, и он привязывается то создается запись в таблице "subscriber"(kamailio), поле - is_insert_kamailio проставляется true,
        а также создается запись в таблице "queue_members"(asterisk), поле - is_insert_queue проставляется true
    - если обновляется department_id, удаляется и создается заново запись в таблице "queue_members"(asterisk),
        такой флоу - чтоб агент не наследовал настройки очереди
    - если при обновление у сотрудника нет sip или его нет в таблице location(kamailio), то ему устанавливается статус "error"
M EmployeeDelete - удаление сотрудника
    - удаляется запись из таблицы "subscriber"(kamailio)
    - удаляется запись из таблицы "queue_members"(asterisk)
M EmployeeChangeStatus - смена статуса сотрудника, сотрудник может изменить только себе статус, админ всем
    - если у пользователя ставиться на паузу (pause), ему проставляется пауза в таблице "queue_members"(asterisk),
        через команду ami (QueuePauseAction), если снимается с паузы, то и снимается в таблице "queue_members"(asterisk),
        через команду ami (QueueUnpauseAction)

Q Employees - список сотрудников с пагинацией
    - фильтры: id, per_page, page, status, department_id, sip_id
    - доступен для employee
Q EmployeesList - список сотрудников без пагинацией
    - фильтры: id, status, department_id,  sip_id, search
        search - поиск по фи и email, если приходит два слова то поиска будет только по имени
            первое слово для fist_name, второе - last_name
    - доступен для employee
--------------------------------------------------------------
-- AUTH

M Login - мутация для авторизации админа и сотрудника
	- орентироваться по тому кто авторизовался по полю guard(значения: graph_admin,graph_employee)
	- создается запись в таблице "logins"
	- если логинится сотрудник, проверяется его sip в таблице "location"(kamailio), если нет записи или
	    нет sip, сотруднику проставляется статус "error"

M ForgotPassword - мутация для отправки ссылки для сброса пароля. На почту клиента приходит ссылка в виде {link}/{token}, {link}.
M ResetPassword - мутация принимает токен, ранее отправленный на почту в виде ссылки на фронт.
M CheckPasswordToken - мутация для проверки токена при сбросе пароля

Q EmployeeProfile - получение авторизованого профиля сотрудника
	здесь можно получить роль и разрешения для роли
M EmployeeLogout - логаут для сотрудника
M EmployeeRefreshToken - обновление токенов для сотрудника
M EmployeeChangePassword - изменение пароля сотрудника
--------------------------------------------------------------
-- TRANSLATION

Q TranslatesFilterable - список переводов, с пагинацией
    - фильтры: place, key, text, lang, page, per_page, search (поиск по ключу или тексту)

M CreateOrUpdateTranslate - создание или обновление текущего перевода
    - lang - только 'en'
M DeleteTranslate - удаление перевода
--------------------------------------------------------------
-- CALL HISTORY

- данные о истории звонков тянуться из таблицы "cdr"(asterisk), через воркер - "workers:sync_cdr",
    раз в минуту, вытягиваются данные, только те у которых:
        - поле lastapp = ['Dial', 'Queue', 'Hangup']
        - в поле employee_uuid есть наши сотрудники
        - в поле department есть наши отделы
        - в поле is_fetch = null|false
    когда запись записана в бд телефонии, в таблицы "cdr" в поле is_fetch ставить true, чтоб больше эту запись
    не вытягивать (todo нужно добавить транзакционость)
- при загрузке записей по истории получаем статус из поля "disposition", если там есть значение "NO ANSWER", то
    смотрим поле "true_reason_hangup", если там есть значение, берем его как статус если там пусто,
    проставляем статус "NO ANSWER"
- поля в таблице "cdr", которые извлекаются
    calldate - дата начало звонка
    clid - полная инфа (имя) про инициатора звонка
    src - тел. номер инициатора звонка
    dst - тел. номер ответившего агента
    lastapp - устройство на котором закончен звонок (QUEUE - очередь, DIAL - обычный телефон)
    duration - время звонка, вместе с ожиданием (сек.)
    billsec - время звонка, без ожиданием (сек.)
    disposition - статус
    employee_uuid - гуид сотрудник, который принял звонок
    department - название отдела(очереди)
    case_id
    serial - serial_number
    uniqueid - уникальный id, но по факту не уникален, т.к. может повторяться, относясь к одно пользователю,
        при уникальности нужно смотреть на два поля - uniqueid, calldate
- линк на аудио запись звонка формируется только при статусе - "answered" и имеет формат

Q CallHistories - список записей с пагинацией
    - фильтры: id, per_page, page, department_id, status, date_from, date_to
        date_from - дата от, фильтр по полю call_date, формат - 'Y-m-d'
        date_to - дата до, фильтр по полю call_date, формат - 'Y-m-d'
    - поиск: serial_number, case_id, search
        search - поиск по имени или телефону клиента и агента(сотрудника)
    - сортировка: call_date
    - сотрудник видит только свои записи
--------------------------------------------------------------
-- QUEUE

мониторинг звонков в очереди
- статусы (состояния звонка клиента)
     wait - звонок появился в очереди, но он еще не распределился на агента
     connection - звонок распределился на агента, но агент еще не ответил, появляется дата - connected_at
     talk - агент ответил на звонок, появляется дата - called_at
     cancel - звонок завершен
- если добавлены - comment, serial_number, case_id - будут подтянуты в call-history (связующий ключ channel)
- статус wait, connection, также сам запись заходит здесь (@see App\Console\Commands\Helpers\PAMI\QueueEntryHandler)
- статус talk, cancel, проставляются здесь (@see App\PAMI\Listener\PAMI\QueueStatusListener)
- также статус - cancel устанавливается при загрузки истории при case_11 (@see App\IPTelephony\Services\Storage\Asterisk\CdrService)
- отдел(очередь) появляется сразу, агент(employee) - только во время connection

-- для фронта
    фронт должен запрашивать записи все, кроме статуса - cancel
    таймер "waiting" запускать от значений wait (кол-во секунд в ожидании, приходит с ami)
    таймер "connecting" запускать от значений connected_at (дата)
    таймер "duration" запускать от значений called_at (дата)

Q CallQueues - список активных очередей, с пагинацией
    - фильтры: id, department_id, statuses
    - поиск: serial_number, case_id, search (поиск по имени,телефону клиента и комментарию)
Q CallQueuesList - список активных очередей, без пагинации
    - фильтры: id, department_id, statuses
    - поиск: serial_number, case_id, search (поиск по имени,телефону клиента и комментарию)

M CallQueueUpdate - обновление записи, добавление имени клиента, case_id, serial_number, comment
M CallQueueTransferToAgent - трансфер звонка на агента
M CallQueueTransferToDepartment - трансфер звонка на отдел(очередь)
--------------------------------------------------------------
-- Report

- отчеты по звонкам сотрудников

Q ReportItems - список записей позвонкам,по конкретному очтету(агенту), с пагинацией
    - фильтры: report_id (require), date_from, date_to
    - поиск: search (поиск по имени,телефону клиента)
Q Reports - список отчетов (всех агентов), c пагинации
    - фильтры: id
Q ReportsAdditionalQuery - получение доп. данных по отчетам, таких как:
    - total_calls - кол-во звонков
    - total_wait - общее время ожидания
    - total_time - общее время звонка
  для данной квери работают фильтры как и для Reports, и данные формируются в зависимости от
  выбранных фильтров
Q ReportItemsAdditionalQuery - получение доп. данных по звонкам отчета, таких как:
    - total_calls - кол-во звонков
    - total_dropped - кол-во не отвеченных звонков
    - total_wait - общее время ожидания
    - total_time - общее время звонка
  для данной квери работают фильтры как и для ReportItems, и данные формируются в зависимости от
  выбранных фильтров

Q ReportsExcel - ссылка для скачивания excel-файла, отчетов
    для данной квери работают фильтры как и для Reports, и данные формируются в зависимости от
      выбранных фильтров
Q ReportItemsExcel - ссылка для скачивания excel-файла, звонков отчета
    для данной квери работают фильтры как и для ReportItems, и данные формируются в зависимости от
      выбранных фильтров
--------------------------------------------------------------
-- Статусы
-- по пользователям

- при авторизации пользователя проверяем есть ли его sip в таблице "location"(kamailio), если нет, то
проставляем ему статус error, так как его (устройства) физически нет в системе телефонии
- запускаем worker, который каждую минуту будет проверять наличие пользователе в таблице "location"(kamailio),
и проставлять статус error если там нет пользователя
- pami:listener - слушает события ami, прослушивая события QueueMemberStatusEvent проставляем статус сотрудника:
    если приходит статус - 1, то проставляем статус "free", если приходит 2 - то проставляем статус "talk"
    (статус 2 - приходит в момент совершения звонка), при этом также смотрим на параметр "paused", если он
    true - то в любом случае проставляем статус paused

--------------------------------------------------------------
